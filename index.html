<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Croquette Factory - Calculateur de ration pour chien</title>
    <meta property="og:title" content="My Croquette Factory - Calculateur de ration pour chien" />
    <meta property="og:description" content="Calculez la ration journalière idéale de votre chien en fonction de son poids, de ses croquettes et de son profil." />
    <meta property="og:image" content="http://benjamin.mur.free.fr/cover.jpg" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="My Croquette Factory - Calculateur de ration pour chien" />
    <meta name="twitter:description" content="Un calculateur simple pour ajuster la ration de croquettes de votre compagnon." />
    <meta name="twitter:image" content="http://benjamin.mur.free.fr/cover.jpg" />
    <style>
        :root {
            color-scheme: light dark;
            --bg-gradient: radial-gradient(circle at 20% 20%, #ffdac1, rgba(255, 218, 193, 0) 55%),
            radial-gradient(circle at 80% 30%, #ffd5ef, rgba(255, 213, 239, 0) 55%),
            radial-gradient(circle at 50% 80%, #c9f7ff, rgba(201, 247, 255, 0) 60%),
            linear-gradient(135deg, #121123, #191f45);
            --card-bg: rgba(18, 17, 35, 0.65);
            --card-border: rgba(255, 255, 255, 0.2);
            --text-primary: #f8f9ff;
            --text-muted: rgba(248, 249, 255, 0.75);
            --accent: #ffb344;
            --accent-soft: rgba(255, 179, 68, 0.3);
            --input-bg: rgba(12, 11, 24, 0.9);
            --shadow: 0 24px 50px -30px rgba(0, 0, 0, 0.8);
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            margin: 0;
            padding: 40px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-gradient);
            color: var(--text-primary);
            backdrop-filter: blur(12px);
        }

        .card {
            width: min(640px, 100%);
            padding: 40px 36px;
            border-radius: 28px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        .card::after {
            content: "";
            position: absolute;
            inset: 0;
            z-index: -1;
            background: linear-gradient(135deg, rgba(255, 179, 68, 0.08), transparent 45%),
            linear-gradient(315deg, rgba(89, 156, 255, 0.08), transparent 55%);
        }

        h1 {
            margin: 0 0 12px;
            font-size: clamp(1.4rem, 2.6vw, 1.9rem);
            letter-spacing: -0.03em;
        }

        .brand {
            margin: 0 0 18px;
            font-size: clamp(1.8rem, 4vw, 2.4rem);
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: transparent;
            background: linear-gradient(120deg, #ffee99 0%, #ffb344 45%, #ff72e1 100%);
            -webkit-background-clip: text;
            background-clip: text;
            text-shadow: 0 24px 48px rgba(255, 179, 68, 0.25);
        }

        p.description {
            margin: 0 0 32px;
            color: var(--text-muted);
            line-height: 1.5;
            font-size: 1rem;
        }

        .inputs {
            display: grid;
            gap: 24px;
            margin-bottom: 32px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px 24px;
            border-radius: 18px;
            background: rgba(12, 11, 24, 0.45);
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: transform 160ms ease-out, border-color 160ms ease-out, box-shadow 160ms ease-out;
        }

        .input-group:focus-within {
            transform: translateY(-2px);
            border-color: rgba(255, 179, 68, 0.7);
            box-shadow: 0 16px 35px -28px rgba(255, 179, 68, 0.9);
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            color: rgba(248, 249, 255, 0.78);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 700;
        }

        .number-field {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 14px;
            inline-size: fit-content;
            max-inline-size: 100%;
            width: 100%;
        }

        .input-row {
            display: inline-flex;
            align-items: flex-end;
            gap: 12px;
            width:100%;
        }

        .input-row .unit {
            display: inline-flex;
            align-items: flex-end;
            padding-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .number-field input {
            /*flex: 0 0 auto;*/
            /*inline-size: clamp(150px, 40vw, 240px);*/
            flex: 1;
            font-size: 1.7rem;
            font-weight: 600;
            padding: 10px 0;
            border: none;
            border-bottom: 2px solid rgba(255, 255, 255, 0.16);
            background: transparent;
            color: var(--text-primary);
            outline: none;
            transition: border-bottom-color 160ms ease-out;
            appearance: textfield;
            min-width: 100px;
        }

        .number-field input:focus {
            border-bottom-color: var(--accent);
        }

        .number-field input::-webkit-inner-spin-button,
        .number-field input::-webkit-outer-spin-button {
            appearance: none;
            margin: 0;
        }

        .spin-controls {
            display: inline-flex;
            align-self: flex-start;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.06);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(6px);
        }

        .spin-btn {
            width: 36px;
            height: 28px;
            border: none;
            border-radius: 10px;
            background: rgba(12, 11, 24, 0.5);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease, box-shadow 140ms ease;
            display: grid;
            place-items: center;
        }

        .spin-btn:hover {
            background: rgba(255, 179, 68, 0.18);
            box-shadow: 0 6px 14px -12px rgba(255, 179, 68, 0.9);
        }

        .spin-btn:active {
            transform: scale(0.96);
            background: rgba(255, 179, 68, 0.28);
        }

        .spin-icon {
            width: 12px;
            height: 12px;
            display: inline-block;
            position: relative;
        }

        .spin-icon::before,
        .spin-icon::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 2px;
            border-radius: 999px;
            background: currentColor;
        }

        .spin-icon.up::after {
            transform: translate(-50%, -50%) rotate(90deg);
        }

        .spin-icon.down::after {
            display: none;
        }

        .unit {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .toggle-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .toggle {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            font-size: 0.9rem;
            transition: border-color 160ms ease, background 160ms ease;
        }

        .toggle input {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            margin: 0;
        }

        .toggle:hover {
            border-color: rgba(255, 179, 68, 0.4);
            background: rgba(255, 255, 255, 0.08);
        }

        .toggle-text {
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .helper-text {
            margin: 12px 0 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .input-label-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .input-label-row .input-label {
            /*flex: 1;*/
        }

        .ghost-link {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--accent);
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: border-color 160ms ease, background 160ms ease, color 160ms ease;
        }

        .ghost-link:hover,
        .ghost-link:focus-visible {
            border-color: var(--accent);
            color: var(--text-primary);
            background: rgba(255, 179, 68, 0.1);
            outline: none;
        }

        .calc-results {
            margin-top: 16px;
            padding: 16px 18px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .calc-results[hidden] {
            display: none;
        }

        .calc-result-title {
            margin: 0 0 10px;
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(248, 249, 255, 0.7);
        }

        .calc-result-line {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .calc-result-line strong {
            font-size: 1.1rem;
            color: var(--accent);
        }

        .calc-note {
            margin: 12px 0 0;
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .form-grid {
            display: grid;
            gap: 12px;
        }

        .form-grid.two-columns {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }


        .select-field {
            position: relative;
        }

        .select-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(248, 249, 255, 0.78);
            letter-spacing: 0.01em;
        }

        .select-field select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            background: rgba(12, 11, 24, 0.45);
            color: var(--text-primary);
            font-size: 1rem;
            appearance: none;
        }

        .select-field select:focus {
            outline: none;
            border-color: rgba(255, 179, 68, 0.7);
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 32px 24px;
            background: rgba(4, 5, 18, 0.85);
            backdrop-filter: blur(6px);
            z-index: 1200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 200ms ease-out;
            overflow-y: auto;
        }

        .modal-overlay.is-open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            width: min(520px, 100%);
            background: rgba(18, 17, 35, 0.98);
            border-radius: 28px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            padding: 28px;
            box-shadow: 0 30px 60px -45px rgba(0, 0, 0, 0.8);
            position: relative;
            max-height: calc(100vh - 96px);
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 18px;
        }

        .modal-title {
            margin: 0;
            font-size: 1.35rem;
            letter-spacing: -0.01em;
        }

        .modal-description {
            margin: 0 0 20px;
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .modal-close {
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: grid;
            place-items: center;
            font-size: 1rem;
        }

        .modal-close:hover,
        .modal-close:focus-visible {
            background: rgba(255, 179, 68, 0.2);
            color: var(--accent);
            outline: none;
        }

        .modal label {
            display: block;
            font-size: 0.85rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            margin-bottom: 8px;
            color: rgba(248, 249, 255, 0.8);
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(12, 11, 24, 0.65);
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .nec-grid {
            margin-top: 18px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }

        .nec-option {
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 10px;
            background: rgba(12, 11, 24, 0.45);
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            cursor: pointer;
            transition: border-color 150ms ease, transform 150ms ease, background 150ms ease;
            overflow: hidden;
        }

        .nec-option:hover,
        .nec-option:focus-visible {
            border-color: rgba(255, 179, 68, 0.8);
            outline: none;
            transform: translateY(-2px);
        }

        .nec-option.is-selected {
            border-color: var(--accent);
          background: rgba(255, 179, 68, 0.12);
        }

        .nec-illustration {
            width: 100%;
            height: 110px;
            border-radius: 12px;
            /*object-fit: contain;*/
            display: block;
            background: rgba(255, 255, 255, 0.08);
            padding: 4px;
            border-radius: 15px;
        }

        .nec-score {
            font-weight: 700;
            letter-spacing: 0.02em;
            color: rgba(248, 249, 255, 0.95);
            font-size: 0.95rem;
        }

        .nec-caption {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
        }

        .modal-error {
            min-height: 1em;
            margin-top: 12px;
            font-size: 0.85rem;
            color: #ff8686;
        }

        .modal-actions {
            margin-top: 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            bottom: 0;
            padding-top: 16px;
            background: linear-gradient(180deg, transparent 0%, rgba(18, 17, 35, 0.98) 40%, rgba(18, 17, 35, 0.98) 100%);
        }

        .primary-btn,
        .secondary-btn {
            padding: 10px 18px;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            border: none;
        }

        .primary-btn {
            background: var(--accent);
            color: #2b1900;
        }

        .primary-btn:hover,
        .primary-btn:focus-visible {
            box-shadow: 0 12px 24px -18px rgba(255, 179, 68, 1);
            outline: none;
        }

        .secondary-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
        }

        .secondary-btn:hover,
        .secondary-btn:focus-visible {
            border-color: var(--accent);
            color: var(--accent);
            outline: none;
        }

        .results {
            padding: 28px 32px;
            border-radius: 22px;
            background: linear-gradient(135deg, rgba(255, 179, 68, 0.15), rgba(255, 213, 239, 0.1));
            border: 1px solid rgba(255, 179, 68, 0.25);
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .results-title {
            font-size: 0.95rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(18, 17, 35, 0.65);
            background: rgba(255, 179, 68, 0.9);
            padding: 6px 14px;
            border-radius: 999px;
            font-weight: 700;
        }

        .result-value {
            font-size: clamp(2.6rem, 5vw, 3.4rem);
            font-weight: 700;
            letter-spacing: -0.04em;
            color: #ffffff;
        }

        .result-details {
            color: rgba(248, 249, 255, 0.8);
            font-size: 0.98rem;
            line-height: 1.5;
        }

        .tips {
            margin-top: 36px;
            padding: 20px 24px;
            border-radius: 18px;
            background: rgba(12, 11, 24, 0.35);
            border: 1px dashed rgba(255, 255, 255, 0.18);
            color: var(--text-muted);
            font-size: 0.92rem;
            line-height: 1.6;
        }

        @media (max-width: 540px) {
            body {
                padding: 32px 12px;
            }

            .card {
                padding: 32px 22px;
            }

            .input-group {
                padding: 18px 18px;
                min-width: 300px;
            }

            .results {
                padding: 24px 24px;
            }

            .form-grid.two-columns {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 460px) {
            .input-row {
                gap: 12px;
            }

            .number-field input {
                font-size: 1.5rem;
            }

            .spin-controls {
                align-self: flex-start;
                justify-content: center;
            }

            .spin-btn {
                width: 42px;
                height: 32px;
            }
        }

        @media (max-width: 360px) {
            body {
                padding: 28px 10px;
            }

            .card {
                padding: 28px 18px;
            }

            .spin-btn {
                width: 38px;
                height: 30px;
            }

            .brand {
                font-size: clamp(1.8rem, 6vw, 2.2rem);
            }

            h1 {
                font-size: clamp(1.3rem, 5vw, 1.7rem);
            }

            .nec-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .nec-illustration {
                height: 90px;
            }

            .modal {
                padding: 24px;
            }
        }

    </style>
</head>
<body>
<main class="card">
    <header>
        <div class="brand">My Croquette Factory</div>
        <h1>Plan de ration pour votre compagnon</h1>
    </header>

    <section class="inputs" aria-label="Paramètres ajustables">
        <div class="input-group">
            <div class="input-label-row">
                <label class="input-label" for="dogWeight">
                    <span class="badge">Poids</span>
                    Poids du chien idéal
                </label>
                <button type="button" class="ghost-link" id="openIdealWeightCalc" aria-haspopup="dialog">
                    Calculatrice du poids idéal
                </button>
            </div>
            <div class="number-field">
                <div class="input-row">
                    <input type="number" inputmode="decimal" min="0" step="0.1" id="dogWeight" placeholder="Ex. 12,5" />
                    <span class="unit">kg</span>
                </div>
                <div class="spin-controls" aria-hidden="true">
                    <button type="button" class="spin-btn" data-action="up" aria-label="Augmenter le poids">
                        <span class="spin-icon up"></span>
                    </button>
                    <button type="button" class="spin-btn" data-action="down" aria-label="Diminuer le poids">
                        <span class="spin-icon down"></span>
                    </button>
                </div>
            </div>
        </div>

        <div class="input-group">
            <div class="input-label-row">
                <label class="input-label" for="kcal100">
                    <span class="badge">Énergie</span>
                    Croquettes
                </label>
                <button type="button" class="ghost-link" id="openKcalCalculator" aria-haspopup="dialog">
                    Calculatrice d'énergie
                </button>
            </div>
            <div class="number-field">
                <div class="input-row">
                    <input type="number" inputmode="decimal" min="0" step="1" id="kcal100" placeholder="Ex. 380" />
                    <span class="unit">kcal / 100 g</span>
                </div>
                <div class="spin-controls" aria-hidden="true">
                    <button type="button" class="spin-btn" data-action="up" aria-label="Augmenter les kcal">
                        <span class="spin-icon up"></span>
                    </button>
                    <button type="button" class="spin-btn" data-action="down" aria-label="Diminuer les kcal">
                        <span class="spin-icon down"></span>
                    </button>
                </div>
            </div>
            <div class="calc-results" id="kcalCalculatorSummary" hidden>
                <p class="calc-result-title">Calcul NRC2006</p>
                <div class="calc-result-line" id="kcalSummaryCfRow">
                    <span>Énergie (cellulose brute)</span>
                    <strong id="kcalSummaryCf">—</strong>
                </div>
                <div class="calc-result-line" id="kcalSummaryTdfRow" hidden>
                    <span>Énergie (fibres totales)</span>
                    <strong id="kcalSummaryTdf">—</strong>
                </div>
                <p class="calc-note" id="kcalSummaryNote"></p>
            </div>
        </div>

        <div class="input-group">
            <div class="input-label">
                <span class="badge">Profil</span>
                Métabolisme & activité
            </div>
            <div class="toggle-group" role="group" aria-label="Profil énergétique du chien - stérilisation">
                <label class="toggle" for="isSterilized">
                    <input type="checkbox" id="isSterilized" />
                    <span class="toggle-text">Chien stérilisé (x0,8)</span>
                </label>
            </div>
            <div class="select-field">
                <label class="select-label" for="activityLevel">Niveau d'activité</label>
                <select id="activityLevel" aria-label="Niveau d'activité du chien">
                    <option value="" selected hidden>Sélectionnez un niveau d'activité</option>
                    <option value="sedentaire">Sédentaire&nbsp;: promenade en laisse &lt;1h/jour (x0,8)</option>
                    <option value="equilibre">Équilibré&nbsp;: activité quotidienne modérée (x1)</option>
                    <option value="actif">Actif / sportif&nbsp;: agilité, canicross, VTT, chasse… (x1,2)</option>
                    <option value="athlete">Athlète&nbsp;: +7h d'activité soutenue / semaine (x1,4)</option>
                </select>
            </div>
            <p class="helper-text">Combinez la stérilisation et la sportivité pour refléter le quotidien de votre chien.</p>
        </div>

        <div class="input-group">
            <label class="input-label" for="breedSelect">
                <span class="badge">Race</span>
                Ajustement morphologique
            </label>
            <div class="select-field">
                <select id="breedSelect" aria-label="Race du chien">
                    <option value="" selected hidden>Sélectionnez une race</option>
                    <option value="generic">Autre race (x1)</option>
                    <option value="labrador">Labrador (x0,8)</option>
                    <option value="golden_retriever">Golden retriever (x0,8)</option>
                    <option value="beagle">Beagle (x0,9)</option>
                    <option value="dogue_allemand">Dogue allemand (x1,2)</option>
                    <option value="levrier">Lévrier (x1,2)</option>
                </select>
            </div>
            <p class="helper-text">Choisissez une race pour prendre en compte les besoins spécifiques.</p>
        </div>
    </section>

    <section class="results" aria-live="polite">
        <span class="results-title">Portion quotidienne</span>
        <div id="resultValue" class="result-value">—</div>
        <div id="resultDetails" class="result-details">Entrez vos paramètres pour découvrir la ration sur mesure.</div>
    </section>

    <section class="tips">
        Les données sont enregistrées sur cet appareil. Pensez à ajuster la portion à chaque changement de poids, de croquettes
        ou de routine. Pour un suivi optimal, répartissez la ration sur plusieurs repas.
    </section>
</main>

<div class="modal-overlay" id="idealWeightModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="idealWeightTitle" aria-describedby="idealWeightDescription">
        <div class="modal-header">
            <h2 class="modal-title" id="idealWeightTitle">Calculatrice du poids idéal</h2>
            <button type="button" class="modal-close" data-close-modal="idealWeight" aria-label="Fermer la calculatrice">&times;</button>
        </div>
        <p class="modal-description" id="idealWeightDescription">
            Renseignez le poids actuel et choisissez la Note d'État Corporel (NEC) pour estimer rapidement le poids de forme.
        </p>
        <form id="idealWeightForm">
            <label for="currentWeightInput">Poids actuel du chien (kg)</label>
            <input type="number" inputmode="decimal" min="0" step="0.1" id="currentWeightInput" class="modal-input" placeholder="Ex. 18,2" />

            <div class="nec-grid" role="group" aria-label="Sélectionnez la note d'état corporel">
                <button type="button" class="nec-option" data-nec="1" aria-pressed="false">
                    <img src="ressources/nec1.jpg" class="nec-illustration" alt="Illustration NEC 1 - très maigre" loading="lazy" />
                    <span class="nec-score">NEC 1</span>
                    <span class="nec-caption">Très maigre</span>
                </button>
                <button type="button" class="nec-option" data-nec="3" aria-pressed="false">
                    <img src="ressources/nec3.jpg" class="nec-illustration" alt="Illustration NEC 3 - maigre" loading="lazy" />
                    <span class="nec-score">NEC 3</span>
                    <span class="nec-caption">Maigre</span>
                </button>
                <button type="button" class="nec-option" data-nec="5" aria-pressed="false">
                    <img src="ressources/nec5.jpg" class="nec-illustration" alt="Illustration NEC 5 - optimal" loading="lazy" />
                    <span class="nec-score">NEC 5</span>
                    <span class="nec-caption">Optimal</span>
                </button>
                <button type="button" class="nec-option" data-nec="7" aria-pressed="false">
                    <img src="ressources/nec7.jpg" class="nec-illustration" alt="Illustration NEC 7 - gros" loading="lazy" />
                    <span class="nec-score">NEC 7</span>
                    <span class="nec-caption">Gros</span>
                </button>
                <button type="button" class="nec-option" data-nec="9" aria-pressed="false">
                    <img src="ressources/nec9.jpg" class="nec-illustration" alt="Illustration NEC 9 - obèse" loading="lazy" />
                    <span class="nec-score">NEC 9</span>
                    <span class="nec-caption">Obèse</span>
                </button>
            </div>
            <p class="helper-text" style="margin-top: 16px;">Astuce : demandez à votre vétérinaire de confirmer la note NEC lors des visites de contrôle.</p>
            <div class="modal-error" id="idealWeightError" role="alert" aria-live="assertive"></div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" data-close-modal="idealWeight">Annuler</button>
                <button type="submit" class="primary-btn">Valider et appliquer</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="kcalCalculatorModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="kcalCalculatorTitle" aria-describedby="kcalCalculatorDescription">
        <div class="modal-header">
            <h2 class="modal-title" id="kcalCalculatorTitle">Calculatrice d'énergie (NRC2006)</h2>
            <button type="button" class="modal-close" data-close-modal="kcalCalculator" aria-label="Fermer la calculatrice">&times;</button>
        </div>
        <p class="modal-description" id="kcalCalculatorDescription">
            Entrez les constituants analytiques pour estimer l'énergie métabolisable de vos croquettes pour chien (kcal / 100 g).
        </p>
        <form id="kcalCalculatorForm" novalidate>
            <div class="form-grid two-columns" style="margin-top: 18px;">
                <div>
                    <label for="energyHumidity">Humidité (%)</label>
                    <input type="number" id="energyHumidity" class="modal-input" name="humidity" min="0" max="100" step="0.1" placeholder="Laisser vide si inconnue" />
                </div>
                <div>
                    <label for="energyProteins">Protéines brutes (%)</label>
                    <input type="number" id="energyProteins" class="modal-input" name="proteins" min="0" max="100" step="0.1" required />
                </div>
                <div>
                    <label for="energyFats">Lipides / matières gr.&nbsp;(%)</label>
                    <input type="number" id="energyFats" class="modal-input" name="fats" min="0" max="100" step="0.1" required />
                </div>
                <div>
                    <label for="energyAsh">Cendres / minéraux (%)</label>
                    <input type="number" id="energyAsh" class="modal-input" name="ash" min="0" max="100" step="0.1" required />
                </div>
                <div>
                    <label for="energyFiber">Cellulose brute (%)</label>
                    <input type="number" id="energyFiber" class="modal-input" name="fiber" min="0" max="100" step="0.1" required />
                </div>
                <div>
                    <label for="energyTotalFiber">Fibres totales (%)</label>
                    <input type="number" id="energyTotalFiber" class="modal-input" name="tdf" min="0" max="100" step="0.1" placeholder="Facultatif si non connu" />
                </div>
            </div>

            <p class="helper-text" style="margin-top: 16px;">
                Si l'humidité n'est pas renseignée, la calculatrice appliquera par défaut 8&nbsp;% (valeur standard pour les croquettes chien).
            </p>

            <div class="modal-error" id="kcalCalculatorError" role="alert" aria-live="assertive"></div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" data-close-modal="kcalCalculator">Fermer</button>
                <button type="submit" class="primary-btn">Valider et appliquer</button>
            </div>
        </form>
    </div>
</div>

<script>
    (function () {
        const STORAGE_KEY = "dogFoodCalculatorPreferences";
        const weightInput = document.getElementById("dogWeight");
        const kcalInput = document.getElementById("kcal100");
        const sterilizedInput = document.getElementById("isSterilized");
        const activitySelect = document.getElementById("activityLevel");
        const breedSelect = document.getElementById("breedSelect");
        const resultValue = document.getElementById("resultValue");
        const resultDetails = document.getElementById("resultDetails");
        const idealWeightButton = document.getElementById("openIdealWeightCalc");
        const idealWeightModal = document.getElementById("idealWeightModal");
        const idealWeightForm = document.getElementById("idealWeightForm");
        const currentWeightField = document.getElementById("currentWeightInput");
        const necOptionButtons = document.querySelectorAll(".nec-option");
        const idealWeightError = document.getElementById("idealWeightError");
        const modalCloseButtons = document.querySelectorAll("[data-close-modal=\"idealWeight\"]");
        const kcalModalCloseButtons = document.querySelectorAll("[data-close-modal=\"kcalCalculator\"]");
        const kcalCalculatorButton = document.getElementById("openKcalCalculator");
        const kcalCalculatorModal = document.getElementById("kcalCalculatorModal");
        const kcalCalculatorForm = document.getElementById("kcalCalculatorForm");
        const kcalCalculatorError = document.getElementById("kcalCalculatorError");
        const humidityField = document.getElementById("energyHumidity");
        const proteinsField = document.getElementById("energyProteins");
        const fatsField = document.getElementById("energyFats");
        const ashField = document.getElementById("energyAsh");
        const celluloseField = document.getElementById("energyFiber");
        const totalFiberField = document.getElementById("energyTotalFiber");
        const kcalSummary = document.getElementById("kcalCalculatorSummary");
        const kcalSummaryCfRow = document.getElementById("kcalSummaryCfRow");
        const kcalSummaryCfValue = document.getElementById("kcalSummaryCf");
        const kcalSummaryTdfRow = document.getElementById("kcalSummaryTdfRow");
        const kcalSummaryTdfValue = document.getElementById("kcalSummaryTdf");
        const kcalSummaryNote = document.getElementById("kcalSummaryNote");
        const clearEnergySummary = () => {
            if (!kcalSummary) return;
            kcalSummary.hidden = true;
            if (kcalSummaryCfValue) kcalSummaryCfValue.textContent = "—";
            if (kcalSummaryTdfValue) kcalSummaryTdfValue.textContent = "—";
            if (kcalSummaryTdfRow) kcalSummaryTdfRow.hidden = true;
            if (kcalSummaryNote) kcalSummaryNote.textContent = "";
        };
        const syncBodyModalState = () => {
            const openModal = document.querySelector(".modal-overlay.is-open");
            document.body.classList.toggle("modal-open", Boolean(openModal));
        };
        const BREED_MODIFIERS = {
            labrador: 0.8,
            golden_retriever: 0.8,
            beagle: 0.9,
            dogue_allemand: 1.2,
            levrier: 1.2,
            generic: 1,
        };
        const STERILIZED_MULTIPLIER = 0.8;
        const ACTIVITY_MULTIPLIERS = {
            equilibre: 1,
            sedentaire: 0.8,
            actif: 1.2,
            athlete: 1.4,
        };

        const formatDecimal = (value, digits = 1) =>
            Number.isFinite(value) ? value.toLocaleString("fr-FR", { minimumFractionDigits: digits, maximumFractionDigits: digits }) : "—";

        const getLifestyleModifier = () => {
            let modifier = 1;
            if (sterilizedInput.checked) modifier *= STERILIZED_MULTIPLIER;
            const activityModifier = ACTIVITY_MULTIPLIERS[activitySelect.value] ?? 1;
            modifier *= activityModifier;
            const breedModifier = BREED_MODIFIERS[breedSelect.value] ?? 1;
            return modifier * breedModifier;
        };

        const loadPreferences = () => {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;
                const { weight, kcals, isSterilized, activityLevel, isSporty, breed } = JSON.parse(saved);
                if (typeof weight === "number" && Number.isFinite(weight)) weightInput.value = weight;
                if (typeof kcals === "number" && Number.isFinite(kcals)) kcalInput.value = kcals;
                if (typeof isSterilized === "boolean") sterilizedInput.checked = isSterilized;
                if (typeof activityLevel === "string") {
                    const hasActivityOption = Array.from(activitySelect.options).some((option) => option.value === activityLevel);
                    activitySelect.value = hasActivityOption ? activityLevel : "";
                } else if (typeof isSporty === "boolean" && isSporty) {
                    activitySelect.value = "actif";
                }
                if (typeof breed === "string") {
                    const hasOption = Array.from(breedSelect.options).some((option) => option.value === breed);
                    breedSelect.value = hasOption ? breed : "";
                }
            } catch (error) {
                console.warn("Impossible de charger les préférences:", error);
            }
        };

        const storePreferences = () => {
            const weight = parseFloat(weightInput.value);
            const kcals = parseFloat(kcalInput.value);
            try {
                localStorage.setItem(
                    STORAGE_KEY,
                    JSON.stringify({
                        weight,
                        kcals,
                        isSterilized: sterilizedInput.checked,
                        activityLevel: activitySelect.value || "",
                        breed: breedSelect.value || "",
                    })
                );
            } catch (error) {
                console.warn("Impossible de sauvegarder les préférences:", error);
            }
        };

        const renderResult = () => {
            const weight = parseFloat(weightInput.value);
            const kcals = parseFloat(kcalInput.value);

            if (!Number.isFinite(weight) || weight <= 0) {
                resultValue.textContent = "—";
                resultDetails.textContent = "Indiquez le poids de votre chien pour commencer le calcul.";
                return;
            }

            if (!Number.isFinite(kcals) || kcals <= 0) {
                resultValue.textContent = "—";
                resultDetails.textContent = "Précisez le nombre de kcal pour 100 g de vos croquettes.";
                return;
            }

            const baseRequirement = 110 * Math.pow(weight, 0.75);
            const energyRequirement = baseRequirement * getLifestyleModifier();
            const dailyPortionGrams = (energyRequirement / kcals) * 100;
            const portionPerMeal = dailyPortionGrams / 2;

            resultValue.textContent = `${formatDecimal(dailyPortionGrams, 0)} g`;
            resultDetails.innerHTML = `
          Besoin énergétique estimé&nbsp;: <strong>${formatDecimal(energyRequirement, 0)} kcal/jour</strong>.<br />
          Répartissez idéalement en deux repas d'environ <strong>${formatDecimal(portionPerMeal, 0)} g</strong> chacun.
        `;
        };

        const handleInput = () => {
            storePreferences();
            renderResult();
        };

        if (idealWeightButton && idealWeightModal && idealWeightForm && currentWeightField) {
            let selectedNecValue = "";

            const setModalVisibility = (isOpen) => {
                idealWeightModal.classList.toggle("is-open", isOpen);
                idealWeightModal.setAttribute("aria-hidden", isOpen ? "false" : "true");
                syncBodyModalState();
            };

            const updateNecSelection = () => {
                necOptionButtons.forEach((button) => {
                    const isActive = button.dataset.nec === selectedNecValue;
                    button.classList.toggle("is-selected", isActive);
                    button.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
            };

            const openIdealWeightModal = () => {
                selectedNecValue = "";
                updateNecSelection();
                idealWeightError.textContent = "";
                currentWeightField.value = weightInput.value || "";
                setModalVisibility(true);
                setTimeout(() => currentWeightField.focus(), 50);
            };

            const closeIdealWeightModal = () => {
                setModalVisibility(false);
                idealWeightError.textContent = "";
                selectedNecValue = "";
                updateNecSelection();
            };

            const handleNecSelection = (value) => {
                selectedNecValue = selectedNecValue === value ? "" : value;
                updateNecSelection();
            };

            const handleIdealWeightSubmit = (event) => {
                event.preventDefault();
                idealWeightError.textContent = "";
                const currentWeight = parseFloat(currentWeightField.value);
                if (!Number.isFinite(currentWeight) || currentWeight <= 0) {
                    idealWeightError.textContent = "Veuillez renseigner un poids actuel valide.";
                    return;
                }
                if (!selectedNecValue) {
                    idealWeightError.textContent = "Sélectionnez la note d'état corporel pour continuer.";
                    return;
                }
                const necScore = Number(selectedNecValue);
                const idealWeight =
                    (currentWeight * 100) / (100 + (necScore - 5) * 10);
                if (!Number.isFinite(idealWeight) || idealWeight <= 0) {
                    idealWeightError.textContent = "Le calcul a échoué. Vérifiez les valeurs saisies.";
                    return;
                }
                weightInput.value = idealWeight.toFixed(1);
                handleInput();
                closeIdealWeightModal();
            };

            idealWeightButton.addEventListener("click", openIdealWeightModal);
            modalCloseButtons.forEach((button) => {
                button.addEventListener("click", closeIdealWeightModal);
            });
            necOptionButtons.forEach((button) => {
                button.addEventListener("click", () => handleNecSelection(button.dataset.nec));
            });
            idealWeightForm.addEventListener("submit", handleIdealWeightSubmit);
            idealWeightModal.addEventListener("click", (event) => {
                if (event.target === idealWeightModal) {
                    closeIdealWeightModal();
                }
            });
            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape" && idealWeightModal.classList.contains("is-open")) {
                    closeIdealWeightModal();
                }
            });
        }

        if (kcalCalculatorButton && kcalCalculatorModal && kcalCalculatorForm) {
            const DEFAULT_HUMIDITY = 8;
            const DOG_COEFFS = {
                cf: { a: 91.2, b: 1.43, c: 1.04 },
                tdf: { a: 96.6, b: 0.95, c: 1.04 },
            };

            const setKcalModalVisibility = (isOpen) => {
                kcalCalculatorModal.classList.toggle("is-open", isOpen);
                kcalCalculatorModal.setAttribute("aria-hidden", isOpen ? "false" : "true");
                syncBodyModalState();
            };

            const parseNumberValue = (input) => {
                if (!input) return null;
                const raw = String(input.value ?? "").replace(",", ".").trim();
                if (raw === "") return null;
                const parsed = Number.parseFloat(raw);
                return Number.isFinite(parsed) ? parsed : null;
            };

            const resetEnergyFeedback = () => {
                kcalCalculatorError.textContent = "";
            };

            const gatherEnergyData = () => {
                const proteins = parseNumberValue(proteinsField);
                const fats = parseNumberValue(fatsField);
                const ash = parseNumberValue(ashField);
                const cellulose = parseNumberValue(celluloseField);
                if (![proteins, fats, ash, cellulose].every((value) => Number.isFinite(value))) {
                    kcalCalculatorError.textContent = "Merci de renseigner tous les champs obligatoires.";
                    return null;
                }

                const humidityInput = parseNumberValue(humidityField);
                const humidity = Number.isFinite(humidityInput) ? humidityInput : DEFAULT_HUMIDITY;
                if (!(humidity >= 0 && humidity < 100)) {
                    kcalCalculatorError.textContent = "L'humidité doit être comprise entre 0 et 100 % (hors 100).";
                    return null;
                }

                const fibresTotales = parseNumberValue(totalFiberField);
                const ENA = 100 - (proteins + fats + ash + cellulose + humidity);
                if (ENA < 0) {
                    kcalCalculatorError.textContent = "La somme des constituants dépasse 100 %. Vérifiez vos valeurs.";
                    return null;
                }

                const DMfactor = 100 / (100 - humidity);
                return {
                    proteins,
                    fats,
                    ash,
                    cellulose,
                    fibresTotales,
                    humidity,
                    hasCustomHumidity: Number.isFinite(humidityInput),
                    ENA,
                    DMfactor,
                };
            };

            const computeEnergyValue = (data, useTdf = false) => {
                if (!data) return null;
                const coeff = DOG_COEFFS[useTdf ? "tdf" : "cf"];
                if (!coeff) return null;
                const fiberValue = useTdf ? data.fibresTotales : data.cellulose;
                if (useTdf && !Number.isFinite(fiberValue)) {
                    return null;
                }
                const energieBrute = 5.7 * data.proteins + 9.4 * data.fats + 4.1 * (data.cellulose + data.ENA);
                const digestibilite = (coeff.a - coeff.b * fiberValue * data.DMfactor) / 100;
                const energieDigestible = energieBrute * digestibilite;
                const energieMetabolisable = energieDigestible - coeff.c * data.proteins;
                const rounded = Math.round(energieMetabolisable);
                return Number.isFinite(rounded) ? rounded : null;
            };

            const openKcalCalculator = () => {
                resetEnergyFeedback();
                setKcalModalVisibility(true);
                const focusTarget = proteinsField?.value ? fatsField : proteinsField;
                setTimeout(() => focusTarget?.focus(), 50);
            };

            const closeKcalCalculator = () => {
                setKcalModalVisibility(false);
            };

            const handleKcalCalculatorSubmit = (event) => {
                event.preventDefault();
                kcalCalculatorError.textContent = "";
                if (!kcalCalculatorForm.checkValidity()) {
                    kcalCalculatorForm.reportValidity();
                    return;
                }
                const data = gatherEnergyData();
                if (!data) return;

                const energyCf = computeEnergyValue(data, false);
                if (!Number.isFinite(energyCf)) {
                    kcalCalculatorError.textContent = "Impossible de calculer l'énergie avec ces valeurs.";
                    return;
                }
                const energyTdf = computeEnergyValue(data, true);
                const celluloseDry = data.cellulose * data.DMfactor;
                const preferTdf = Number.isFinite(energyTdf) && celluloseDry > 8;
                const appliedEnergy = preferTdf && Number.isFinite(energyTdf) ? energyTdf : energyCf;

                if (!Number.isFinite(appliedEnergy)) {
                    kcalCalculatorError.textContent = "Impossible d'appliquer le calcul avec ces valeurs.";
                    return;
                }

                clearEnergySummary();
                if (kcalSummary && kcalSummaryNote && kcalSummaryCfValue) {
                    const noteParts = [];
                    if (Number.isFinite(energyTdf)) {
                        noteParts.push(
                            preferTdf
                                ? "Cellulose brute sur matière sèche ≥ 8 %, usage de la formule basée sur les fibres totales."
                                : "Cellulose brute sur matière sèche < 8 %, usage de la formule cellulose brute."
                        );
                    } else {
                        noteParts.push("Fibres totales non renseignées : calcul via la formule cellulose brute.");
                    }
                    if (!data.hasCustomHumidity) {
                        noteParts.push(
                            `Humidité estimée automatiquement à ${data.humidity.toLocaleString("fr-FR", {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 1,
                            })} %.`
                        );
                    }
                    kcalSummary.hidden = false;
                    if (kcalSummaryCfRow) {
                        kcalSummaryCfRow.hidden = false;
                    }
                    kcalSummaryCfValue.textContent = `${energyCf.toLocaleString("fr-FR")} kcal/100 g`;
                    if (kcalSummaryTdfValue && kcalSummaryTdfRow) {
                        if (Number.isFinite(energyTdf)) {
                            kcalSummaryTdfRow.hidden = false;
                            kcalSummaryTdfValue.textContent = `${energyTdf.toLocaleString("fr-FR")} kcal/100 g`;
                        } else {
                            kcalSummaryTdfRow.hidden = true;
                        }
                    }
                    noteParts.push(`Valeur injectée : ${appliedEnergy.toLocaleString("fr-FR")} kcal/100 g.`);
                    kcalSummary.hidden = false;
                    kcalSummaryNote.textContent = noteParts.join(" ");
                }

                kcalInput.value = appliedEnergy;
                handleInput();
                closeKcalCalculator();
            };

            kcalCalculatorButton.addEventListener("click", openKcalCalculator);
            kcalModalCloseButtons.forEach((button) => button.addEventListener("click", closeKcalCalculator));
            kcalCalculatorForm.addEventListener("submit", handleKcalCalculatorSubmit);
            kcalCalculatorForm.addEventListener("input", () => {
                resetEnergyFeedback();
            });
            kcalCalculatorModal.addEventListener("click", (event) => {
                if (event.target === kcalCalculatorModal) {
                    closeKcalCalculator();
                }
            });
            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape" && kcalCalculatorModal.classList.contains("is-open")) {
                    closeKcalCalculator();
                }
            });
        }

        const attachSpinControls = (input) => {
            const container = input.closest(".number-field");
            if (!container) return;
            const controls = container.querySelectorAll(".spin-btn");
            controls.forEach((btn) => {
                btn.addEventListener("click", () => {
                    if (btn.dataset.action === "up") {
                        input.stepUp();
                    } else {
                        input.stepDown();
                    }
                    input.dispatchEvent(new Event("input", { bubbles: true }));
                });
            });
        };

        loadPreferences();
        renderResult();

        weightInput.addEventListener("input", handleInput);
        kcalInput.addEventListener("input", (event) => {
            if (event && event.isTrusted) {
                clearEnergySummary();
            }
            handleInput(event);
        });
        sterilizedInput.addEventListener("input", handleInput);
        activitySelect.addEventListener("change", handleInput);
        breedSelect.addEventListener("change", handleInput);
        attachSpinControls(weightInput);
        attachSpinControls(kcalInput);
    })();
</script>
</body>
</html>
